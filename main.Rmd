---
title: "main"
output: html_document
date: '2022-03-16'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Import Libraries
library(neuralnet)
library(gmodels)
library(class)
library(caret)
```

# Preliminary Analysis

## Load Dataset
```{r}
wq = read.csv('water_potability.csv')
```

## Getting Data Ready for Analysis

```{r}
# Fill NA values with Median Values
wq$ph <- ifelse(is.na(wq$ph), median(wq$ph, na.rm = TRUE),wq$ph)
wq$Sulfate <- ifelse(is.na(wq$Sulfate), median(wq$Sulfate, na.rm = TRUE),wq$Sulfate)
wq$Trihalomethanes <- ifelse(is.na(wq$Trihalomethanes), median(wq$Trihalomethanes, na.rm = TRUE),wq$Trihalomethanes)
summary(wq)

# Using model.matrix to convert all the factors to dummy variables
# We are converting all of the factors into dummy variables as the input into knn has to be numeric

wqm <- as.data.frame(model.matrix(~.-1,wq))
str(wqm)

# Randomize the rows in the data (shuffling the rows)
set.seed(12345)
wqm_random <- wqm[sample(nrow(wqm)),]

# Normalize the data
normalize <- function(x) {
  return ((x - min(x)) / (max(x) - min(x)))
}

# we are going to normalize everything 
wqm_norm <- as.data.frame(lapply(wqm_random, normalize))
```

## Getting Train and Test Samples

```{r}
# Selects 10000 random rows for test data
set.seed(12345)
test_set <- sample(1:nrow(wqm_norm), 650) 
# Depending on R-version and computer, different rows may be selected. 
# If that happens, results are different. 

# Create a train set and test set
# First the predictors - all columns except the Potability column
wq_train <- wqm_norm[-test_set, -match("Potability",names(wqm_norm))]
wq_test <- wqm_norm[test_set, -match("Potability",names(wqm_norm))]

# Now the response (aka Labels) - only the Potability column
wq_train_labels <- wqm_norm[-test_set, "Potability"]
wq_test_labels <- wqm_norm[test_set, "Potability"]
```

------------------------------------------------------------------------

# Creating ANN Model

## With 1 Neuron

```{r}
# Create ANN Model
ann_wq_model <- neuralnet(formula = wq_train_labels ~ .,
                              data = wq_train)

# Plot ANN Model
plot(ann_wq_model)
```

```{r}
## Evaluate Model Results
ann_wq_test_predict <- predict(ann_wq_model, wq_test, type = 'Potabality')
threshold = median(ann_wq_test_predict)
ann_wq_test_predict <- ifelse(ann_wq_test_predict > threshold , 1, 0)


# Run Confusion Matrix
confusionMatrix(as.factor(ann_wq_test_predict),as.factor(wq_test_labels), positive = "1")
```

## With 2 Neurons

```{r}
# Create ANN Model
ann_wq_model2 <- neuralnet(formula = wq_train_labels ~ .,
                              data = wq_train, hidden = 2)

# Plot ANN Model
plot(ann_wq_model2)
```

```{r}
## Evaluate Model Results
ann_wq_test_predict2 <- predict(ann_wq_model2, wq_test, type = 'Potabality')
threshold = median(ann_wq_test_predict2)
ann_wq_test_predict2 <- ifelse(ann_wq_test_predict2 > threshold , 1, 0)


# Run Confusion Matrix
confusionMatrix(as.factor(ann_wq_test_predict2),as.factor(wq_test_labels), positive = "1")
```

------------------------------------------------------------------------

# Build Logistic Regression

```{r}
# Initial Model With All Variables
lg_model1 <- glm(wq_train_labels ~ ., data = wq_train, family = binomial(link='logit'))
summary(lg_model1)
```

```{r}
# Filtered Model with Significant Variables from Model 1
lg_model2 <- glm(wq_train_labels ~ Solids, data = wq_train, family = binomial(link='logit'))
summary(lg_model2)
```

```{r}
# Predict Test Data with Logistical Regression q
lg_predict <- predict(lg_model1, newdata = wq_test, response = "response")
threshold = median(lg_predict)
lg_predict <- ifelse(lg_predict > threshold, 1, 0)

# Evaluate Model Results
confusionMatrix(as.factor(lg_predict),as.factor(wq_test_labels), positive = "1")
```

```{r}
# Predict Test Data with Logistical Regression q
lg_predict2 <- predict(lg_model2, newdata = wq_test, response = "response")
threshold2 = median(lg_predict2)
lg_predict2 <- ifelse(lg_predict2 > threshold2, 1, 0)

# Evaluate Model Results
confusionMatrix(as.factor(lg_predict2),as.factor(wq_test_labels), positive = "1")
```